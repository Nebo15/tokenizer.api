language: elixir
sudo: required
cache:
  directories:
  - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    - secure: qLLXSDnVhOuI7KPYVVXUn33HQz9p4acCFGIzH+/ldVVH7Gve7xUBrnD91CBgyVkdrol2w3O9u0aAe7/n2oIGIip94feboinIAsl5X2HbHUxhxTo1mKbi1PfDC7w7fYVNjzA4EsnTAmZbFcgaH9dO+XHBk8JjSDimT/PrxJRipxElYLlI7A4mgfYLkLp3Y9dVDWw4sec/guov9Zpfy31I+TRBPVLL/0ljAjvFHMPonJ/jJyVgjFp85W7sv1NhLVOdF3djmvJGmD4BUEFSocj9aCf7VDHn3yH0VtEkXmxWqGbz83+n/dtzdJp12qoiwfcoTi8eKjn+bza8Soq4zilcGrwRjUutX+JxVycESsbDiX+ROsq8GlIR3K8psKmL/XVh0D/cbTxiWsT6bZZBSyihvrKXXlx8jOqyyCHnFxcZPtCzhTEhuP7WRerogqA/QQFckqNtnCaIaEp03RIzy142RRR0xbPRcHT0TehK05jCDKDf/m322cV0+8m3KNCTuacTwZW53rlvQuN2mGyF8tZbcjXCAZoa9Bp/R2mo43x75iNUj8ALiKgUOP1aTeD0KMpKZkmYgHkD1tsFoLdwCsGPhqiC37v6jpbY8kAH0k/aXdsSYVAoi+hLNhvr3cssX2lYtfMbzKwPXVLFaf9fE343jQTM6cPRs9//5x/HfJtOFtY="
    - secure: aI8fdolKCm9CDEE54sLMAXKzOyvA28NUcJgV+CxDQzePrMNyvczIk+G2gz/CFAhE9rs83WBV1OeEsJiMgmTmFe8NN2bV2vxSZI3iZTcmgq5tPwsHeuZKACchHQkMVKd84J67e/1Kbt7B6iytA9L8BcstmYt8b+JKRE29CprOmRa27VcCd8/1JNn+ue2oJ2qUpA5XLX32e5P7LjDR1LMaf0VDRPXVJUjNQ0w8H0c0NInBZcHiApapOaByNdat1vRepAVG7yT0M3ur8PoIe0QUqpTlKP8axvxSdW+8/eZF6QXn9FUBxgVEhLc4SE4rLpIRTruTUiO32f+96r5PM2nCqPS+OdiXUdr7uUuu2O+rnzhztYO6tF0NkbSrro7KV2ujhmQQQy0sdN6dNmsqkmdkmee0pxELnYiiD1PmIEpXexA+q9QTlVSz1eYHTgs7ah/MK9foitKwOmMnk8CQqyBzr7OVjnVqxzjYy0BDN11NNt3Y8wEULusePlznPdLq9rZdtuFdh8OUllecG0n/1257CTZmZJXV5ohQKLMauS24o6mUJmJI07YRxUpW7IiqrfHvruQopuvc08g5JW86wFYZo6cKg/kWISAUc/iA5zXX2LXL5uEKnquaj9dU/T13ndCoNBw22UPRHUvYBKQSeZJQCrmMY8TnlCzsklwJbywMaH4=
    - secure: DFsI0qijND95nHqmpJlkO1h+9f0GbIoF3WKk9O3SHrKJioQSRwAhYA5QZJ0hEP110Mc7K43/qG4+njLwM4SRxDuNWyCOUq6dtNIPwC0JpgFRS8l5bAaLMecUJg1DwMaSmC4daORZKw3cElaTwef27rVZo5YwU1HITHhODbp5FU+cx7z/Z8rr3lAyQ8LVCvo/NM8KLTnjxk8N4HcEIsBPBG/YWQ4vciZSJfFeph7fP9tO124B7byjLtBuwggpbhXzImRbHpjXAkhqTeP9ODiZnFvR6BjEf1/O1dVW7U/Ix+UAz41+pvRZ+iKNe0WK1vMoC7fxGG5VlJGBMXLRoMN0cnB2KRvDBumZhk6WumwT9X3+voRwKtW0uplowmli5gbFD8GF4CFkioUYi9jLnlgXRFcDVJKy+z1sUdCwYoPcO/bxXf0ylNtD8eIqYgW5myg3PzMXbn+z8r8a+Yd4opajIT5xauxEvtrugb/k3fOw1E0H8AtZnsgG1+mCiyoT4387c56NCcbGU6DA99tw4wgdgYOvor9iOwRLPZX8A3pMi491MxTa+34sICuQOYHdnaJCpEF4hXAP+uumX9yVFwOJaJ493zvMIhSvB3onCaUiptd16PT4VYhX42sUq5ochSDghoVO4cdsyTbMVn6fNhbmMoR8OMwIgLBWmmRyDgs4opM=
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Install heroku toolchain
  - wget -O- https://toolbelt.heroku.com/install-ubuntu.sh | sh
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - "./bin/version-increment.sh"
  # Install dependencies
  - "mix deps.get"
  # Run all tests except pending ones
  - "mix test --exclude pending --trace"
  # Submit code coverage report to Coveralls
  - "mix coveralls.travis"
  # Run static code analysis
  - "mix credo"
  # Check code style
  - "mix dogma"
  # Build Docker container
  - "./bin/build.sh"
  # Initialize DB for Docker container
  - "MIX_ENV=dev mix ecto.setup"
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
  - if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then echo "[E] Container is not started!"; docker logs gateway_api --details --since 5h; exit 1; fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/*/acceptance"
after_failure:
  - docker logs gateway_api --details --since 5h
after_success:
  - ./bin/ci/push.sh
  - ./bin/ci/deploy.sh
  - docker logs gateway_api --details --since 5h