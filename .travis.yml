language: elixir
sudo: required
cache:
  directories:
  - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    - secure: qLLXSDnVhOuI7KPYVVXUn33HQz9p4acCFGIzH+/ldVVH7Gve7xUBrnD91CBgyVkdrol2w3O9u0aAe7/n2oIGIip94feboinIAsl5X2HbHUxhxTo1mKbi1PfDC7w7fYVNjzA4EsnTAmZbFcgaH9dO+XHBk8JjSDimT/PrxJRipxElYLlI7A4mgfYLkLp3Y9dVDWw4sec/guov9Zpfy31I+TRBPVLL/0ljAjvFHMPonJ/jJyVgjFp85W7sv1NhLVOdF3djmvJGmD4BUEFSocj9aCf7VDHn3yH0VtEkXmxWqGbz83+n/dtzdJp12qoiwfcoTi8eKjn+bza8Soq4zilcGrwRjUutX+JxVycESsbDiX+ROsq8GlIR3K8psKmL/XVh0D/cbTxiWsT6bZZBSyihvrKXXlx8jOqyyCHnFxcZPtCzhTEhuP7WRerogqA/QQFckqNtnCaIaEp03RIzy142RRR0xbPRcHT0TehK05jCDKDf/m322cV0+8m3KNCTuacTwZW53rlvQuN2mGyF8tZbcjXCAZoa9Bp/R2mo43x75iNUj8ALiKgUOP1aTeD0KMpKZkmYgHkD1tsFoLdwCsGPhqiC37v6jpbY8kAH0k/aXdsSYVAoi+hLNhvr3cssX2lYtfMbzKwPXVLFaf9fE343jQTM6cPRs9//5x/HfJtOFtY=
    - secure: Bpaory6A2yqz2fY6ltsf8Jiz3jM9//vJarlPZ3eznKEi2gN9UiFqLC5HEJokeAy59G7zhimiizaRcqFVR7q/xQhGp0Yqhw34wxHHSPmNh/GMh1bqjl9Kx5KUlKsgtIT6NmdIouvwFj5alufzX+oX8Lyq1ZyPBUAy3nsQwfbpcn4Ck6RikVLVpZEQGhMpKl+G+9cTYUaWwJc3NRBf9hXXO9Q4fUr/TY3q36nk1HpXU63NnQ4px/qJ13OItZivAFYYAOR2vfr3b0b9HrEIgZmbzyJe+jgAo1O3ajcNeHd/dWVkUgPoKo84GiEdo6VF+sI6kzbyTBGG1USrqA1clJiu/sOwgQm9KvdywHBaTcloEQeguoDMxmqZ627l8fcT0c3ahddk6P9J6A271TnwDiOmcgor1LuorZ9nFNi7/VCHZw72zEQ0WQEpLwCkRC/NWudGnKA6YV6bJI5U7gkYqRowCjx046iXPDqmGlqJ8pJUaoyHnr81+EZQFa4/STT2DBNRCusTZ1TRrbJe2eWS+P6Q/dnAm3K1b3Is9Od+GlpQtiBCz1U9d64aEkQUt9rX1qPsoHm9NUZKX5U39h3Uws0wO1IX4EXNX/XXcv7JKCjpJcyH2nBiabsHVTv6MfoGNr6hh8lgSSg4gsfZLJiJVZPYhA97XHEyi/O3fIu0SE4/nvw=
    - secure: fu7lClBdQUt+7nGxPwTp9M1hnvuSZwfitobyMqpTLVPXuqJv2Zv48MMyjfM+3CDdeDRHfny/8AngHJTjmt5B5S/EUsVdcu/wqo6kWd3YvbphUfDstS5VzLt8yFKct9gXlW6lzEyxyEwlB+WmJAQyAcBlwYdBa1Lklk2t82S6m66TwahNrs2J/F1LJaKd9q5/1y+xLA1NgI2OA8RvlEM5iSF8zgO8ihZay42YscVe+I5B9SnZtyk2pVYNTrKj3Y1KpF3XPGcg/l4rH+M4ODn4TLsOSEwncK+vZJlAO8M+VqmGRkzDlJj0Bz6UG773N7DqCqF0IutQYvHOvjAZgMGQDzyH3NAmDwE7ncgBuAsMJn9u5ZS7rTz/7RfJK8SAtiUAB+cBUm37sx73mZ3YepufrgX08wrboG08cVd9/WK+W93+iP+UgQo12treic4cCu+dw+Dn35cGAZmWUQSOm266U5ReRb4FWmrJxL2PyZs9Ey7GRPj4gfHmuLHSChwv0kadjRjmlhFKvSbYxtFMlslYgReME4NJYN+/EEeS9dTTkWxjvLToca7eSq+2qnV2CAJM0zFMDvMOCMitdipyDeVCzDb2CzUu3cgT541pm0RVHt4NjHqFetZCK+2z+7PipG1OgKDVRg5AAUhOS7sjKxcg+8vpBa8BXPqT4dWd24ulr2c=
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Install heroku toolchain
  - wget -O- https://toolbelt.heroku.com/install-ubuntu.sh | sh
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - "./bin/version-increment.sh"
  # Install dependencies
  - "mix deps.get"
  # Run all tests except pending ones
  - "mix test --exclude pending --trace"
  # Submit code coverage report to Coveralls
  - "mix coveralls.travis"
  # Run static code analysis
  - "mix credo"
  # Check code style
  - "mix dogma"
  # Build Docker container
  - "./bin/build.sh"
  # Initialize DB for Docker container
  - "MIX_ENV=dev mix ecto.setup"
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
  - if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then echo "[E] Container is not started!"; docker logs gateway_api --details --since 5h; exit 1; fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/*/acceptance"
after_failure:
  - docker logs gateway_api --details --since 5h
after_success:
  - ./bin/ci/push.sh
  - ./bin/ci/deploy.sh
  - docker logs gateway_api --details --since 5h
travis encrypt 'GITHUB_TOKEN=a77de251e9c180cb2d3b5153caf3413893d01826'
travis encrypt 'GITHUB_TOKEN=a77de251e9c180cb2d3b5153caf3413893d01826'