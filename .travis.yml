language: elixir
sudo: required
cache:
  directories:
  - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    - secure: "WjZgzxRCYhxEuvDxJbJlMCCjfNKUDqfsX/NBGiK7H+hqrnx18ud1nZsBB3tCzXUc+ssclUPiuP3xpWG7SAvlN5AGEoVEoWPoQnsk5sGR/Z/vhaLRdWf+W+ZL7Rg+JHtdVSX/DwhLBmCm5hGmzXUdPr6kGqwt0rnYQyMz9uiLr1gmcUTxml8HZNTG9/H1ewbcjD9NARmP8hC/GlMptVlNg3UC7zPFzejHPKuzlAh91M5kEWB8M4wPSCIbn+5Jx9GXzj7skOlqIMQxafxcum6ERan9XybAPVfZchxqI5FlA1XJ3QleAzMpXn/XrWbHea2chvf/1ygqN+0OcUMRxzUzQfFYVDRd1Ojld0T/qTmS7FUZri0+u0shEszO0tQyZT0x0Ny1TND8E5gfPyD15AZwXgZjiTUucSKAK4QlMU1uy0LnPLLvqSgk51qcjGeWnvr+e0KG4eT5Rbzd4OrknQP+00PALvMyxelKTp6iEjLI2Q9n5L1eJqfwh1Sd37FhFQCrotSMNN2elHAtjrD9NRI3bkGK1N4rz3IdpWwU5NoJ/fj/uSK2iUhSL+YZkvFYMNYfOSKLnbFa/CFUwxECb+uSyzkL8MuoxKYFxUQnqYdTjhTlQnR/yg7HXhEMFJQzS+ta7wVUd+ttzRKCHheOJcy3li1OoCIIyZxY3A/iyw7VjKE="
    - secure: "KbKMLeoOKUaTPKs1MsXSOCVa7aloUSlUsKCSrM1haWzsaVufxMiKBjKxuAeR2wTfDFHG6YiVv/wQVXzRw18zs3ti7X/ljkgj2fJWw9qc3lwc9bmTi7Z+QWs+pCm6KaMzU+8W3Yuytp99ufwIpmMqnGq3XMO+q1r3VKd+vnl9i289Iwwt4IxfVvUM4mWQd7vKA2dWdGc8wxS/mohHAwcQtViCPiacylX4YbR/v+Pb3zWUYjApEAyJcDhh/KwmLEhmzxc5beH7y1yivEkwxKmrGZ793hy9oldwiXuJYFeS6rqy1e0mkKClytQjK/8cLukc34OD1d99SjCzM7TyvV3UvUcM0B78KuuG9juC1/deaShqWKIiBTRpGOoCbijbsCk4ECbO/d6iY2cLSnQzs15j+/13S5Q12fuXoBFz0s6byLKAms4VmBzbJ0XQY0TnjLWnplUsmwTYDlKLeNoLxy4J/TAx/FfLOMol/I9ToJ7EJpOR4TGLdL4R5+qP3XmYfku7dleXyUBBPe8HMGokiBH4NlV6yLyKH63lo/QfFShvBblopr4qLAhSdGPF+Mn15D05mi81SOa22rokNh4eg6t5GANwgHsbn+S1kA2pveHgcJWrnhpNXUQQ6391Y36Ul7/wkV7hgR8x6hh1aFCI+98gKuOgbiVx+U7Quw98IHs9f/A="
    - secure: "Gd3tiiiu9yW6QZR+QSTsuJECsLN8d3by/zNLCS1wUIOYbHV2nu4cH2b6lTl0K6CDEsV1TJn5dTRYG/hwncfWP8ZKkzUxnx5zHxtao7L6858o7bn4/i+c4lgS8uIKxzbaRnC61Fjxg04LtClcSDPHyp/1I8N7PaMgxfXctE9onIY0tpSJOielWTumuc/smATaKe0t5IdzmAJbeedduLXHA+TsVNcE9DWYsMXhbl5AQilNtTj1WwEHr6+ctF+ATyPmF5mm3bq4IoYj2tXv9zLC3hDxDWSSMA6GAE7COn1NHdNZbW3/DBINnEV91nteYZg9XZRkWDytwaXUYU5qFoa53o6PA+/EOJrDFynIiznIVh0289WxlVKzS7g1C8Q2UbIimGjZiL13iKveyvcR47mqo+KIbmeMqdz6jcZVs2PJ1/nezc/imgDI0NG2ezOi/nkoSzClNGAavZw7CxLMg4PM/UbzMATIyNJs7hoFcBmJcEry9cUo+P5UzOH7qPKh7CPp5ZVXkqqPKhGgjyUv6UmGe4tVXZ68NgV7u89AbKlSC71m06kF/j2qOXzBEiYNt/75HFr/JjiOacvTuLWg6ssOuEzHcihzmtBDk8TpickYvqHQiIXDxCzhgDHY0FEG8kNxYS8gd0MxDXrkfb8EhoKIZ7eC7ULEMTmLVjaCwmfiPQw="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Install heroku toolchain
  - wget -O- https://toolbelt.heroku.com/install-ubuntu.sh | sh
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - "./bin/version-increment.sh"
  # Install dependencies
  - "mix deps.get"
  # Run all tests except pending ones
  - "mix test --exclude pending --trace"
  # Submit code coverage report to Coveralls
  - "mix coveralls.travis"
  # Run static code analysis
  - "mix credo"
  # Check code style
  - "mix dogma"
  # Build Docker container
  - "./bin/build.sh"
  # Initialize DB for Docker container
  - "MIX_ENV=dev mix ecto.setup"
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
  - if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then echo "[E] Container is not started!"; docker logs gateway_api --details --since 5h; exit 1; fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/*/acceptance"
after_failure:
  - docker logs gateway_api --details --since 5h
after_success:
  - ./bin/ci/push.sh
  - ./bin/ci/deploy.sh
  - docker logs gateway_api --details --since 5h
